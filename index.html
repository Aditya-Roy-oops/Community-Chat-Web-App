<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Community Chat</title>
<style>
:root{
  --bg:#0b0e12; --card:#0f1318; --muted:#99a0a6; --accent:#7c66ff; --glass: rgba(255,255,255,0.03);
}
html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;font-family:Inter,Segoe UI,Roboto,system-ui,Arial}
.app{max-width:920px;margin:20px auto;padding:16px;}
.header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#5bc7ff);display:flex;align-items:center;justify-content:center;font-weight:700}
h1{font-size:20px;margin:0}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(2,6,12,0.6)}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;font-size:14px;color:var(--muted)}
.composer{display:flex;flex-direction:column;gap:12px;padding:12px;margin-top:14px;background:rgba(255,255,255,0.02);border-radius:10px}
.composer .top{display:flex;gap:12px;align-items:center}
.composer input[type=text], .composer textarea{width:100%;background:transparent;border:1px solid rgba(255,255,255,0.1);padding:10px;border-radius:8px;color:inherit}
textarea{min-height:72px;resize:vertical}
.controls{display:flex;gap:8px;margin-top:6px;align-items:center}
.controls input[type=text]{flex:1}
.btn{background:var(--accent);border:none;padding:8px 14px;border-radius:8px;color:#fff;font-weight:600;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
.feed{margin-top:18px;display:flex;flex-direction:column;gap:12px;max-height:62vh;overflow:auto}
.msg-card{background:var(--card);border-radius:12px;padding:12px;display:flex;gap:12px;align-items:flex-start;box-shadow:0 3px 8px rgba(0,0,0,0.3)}
.avatar{width:48px;height:48px;border-radius:50%;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
.msg-body{flex:1}
.msg-header{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:14px}
.msg-name{font-weight:700}
.msg-ts{font-size:12px;color:var(--muted)}
.msg-text{margin-top:6px;font-size:15px;line-height:1.4}
.msg-image{margin-top:8px;border-radius:10px;max-width:100%;max-height:360px;object-fit:cover}
.link-preview{display:flex;gap:10px;border-radius:8px;padding:10px;background:rgba(255,255,255,0.03);margin-top:6px;align-items:center}
.link-preview img{width:80px;height:50px;object-fit:cover;border-radius:6px}
.link-preview .info{display:flex;flex-direction:column;gap:2px;font-size:13px;color:var(--muted)}
.hidden{display:none}
.small{font-size:13px;color:var(--muted)}
.actions{display:flex;gap:8px;margin-top:6px}
.editBtn,.delBtn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">CC</div>
    <div>
      <h1>Community Chat</h1>
      <div class="small">Minimal, dark, hosted on Vercel â€” images in Google Drive</div>
    </div>
  </div>

  <div class="card">
    <div class="topbar">
      <div id="userGreeting">Welcome</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="changeUserBtn">Change Name</button>
      </div>
    </div>

    <!-- Composer -->
    <div class="composer" id="composer">
      <div class="top">
        <div class="avatar" id="meAvatar">U</div>
        <input id="name" type="text" placeholder="Your name"/>
      </div>
      <textarea id="text" placeholder="Share a thought, link or image..."></textarea>
      <div class="controls">
        <input id="link" type="text" placeholder="Optional link (paste a URL)" />
        <input id="imageFile" type="file" accept="image/*" />
        <button class="btn" id="sendBtn">Send</button>
        <button class="btn ghost" id="refreshBtn">Refresh</button>
      </div>
      <div id="linkPreviewArea"></div>
      <div id="imgPreviewArea"></div>
    </div>

    <!-- Feed -->
    <div class="feed" id="feed"></div>
    <div class="small" style="text-align:center;margin-top:6px;" id="feedHint">Loading latest...</div>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzp1cB-VzdgsKFgkSHQ_da_eJcNgwucJpamfZFBc1yK8mxDPx12V2zRKF6yZQpcFvonzQ/exec';
const $ = id => document.getElementById(id);
const ls = window.localStorage;
let lastImageDataUrl = null;

// --- Session
function ensureUser() {
  let name = ls.getItem('cc_name');
  let userId = ls.getItem('cc_userId');
  if(!userId){ userId='u-'+Math.random().toString(36).slice(2,10)+'-'+Date.now().toString(36); ls.setItem('cc_userId', userId);}
  if(!name){ name='Anonymous'; ls.setItem('cc_name', name);}
  setUserUI(name);
}
function setUserUI(name){
  $('userGreeting').textContent = `Hi, ${name}`;
  $('name').value = name;
  $('meAvatar').textContent = name.slice(0,1).toUpperCase();
}
$('changeUserBtn').addEventListener('click', ()=> {
  const n = prompt('Enter your display name', ls.getItem('cc_name')||'Anonymous');
  if(n){ ls.setItem('cc_name', n.trim()); setUserUI(n.trim()); }
});

// --- Image preview
$('imageFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; const area=$('imgPreviewArea'); area.innerHTML='';
  if(!f){ lastImageDataUrl=null; return; }
  if(f.size>3_000_000){ alert('Max ~3MB'); $('imageFile').value=''; return; }
  const reader = new FileReader();
  reader.onload = ()=>{ lastImageDataUrl=reader.result; area.innerHTML=`<img src="${lastImageDataUrl}" class="msg-image">`; };
  reader.readAsDataURL(f);
});

// --- Send message
$('sendBtn').addEventListener('click', async ()=>{
  const name = $('name').value.trim()||'Anonymous';
  const text = $('text').value.trim();
  const link = $('link').value.trim();
  const userId = ls.getItem('cc_userId');
  if(!text && !link && !lastImageDataUrl){ alert('Type something or attach an image/link'); return; }
  const payload = { action:'add', name, text, link, ts:new Date().toISOString(), userId, image:lastImageDataUrl };
  appendMessage({ ...payload, id:'pending-'+Date.now() }, true);
  $('sendBtn').disabled=true; $('sendBtn').textContent='Sending...';
  try{
    const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const j = await res.json();
    await loadMessages(true);
    $('text').value=''; $('link').value=''; $('imageFile').value=''; $('imgPreviewArea').innerHTML=''; lastImageDataUrl=null;
  }catch(err){ console.error(err); alert('Send failed'); }
  finally{ $('sendBtn').disabled=false; $('sendBtn').textContent='Send'; }
});

// --- Load messages
let feedOffset=0, loading=false, totalMessages=0;
async function loadMessages(reset){
  if(loading) return; loading=true;
  if(reset){ feedOffset=0; $('feed').innerHTML=''; }
  $('feedHint').textContent='Loading...';
  try{
    const res = await fetch(`${SCRIPT_URL}?action=list&start=${feedOffset}&limit=20`);
    const j = await res.json();
    const msgs = j.messages||[];
    msgs.reverse().forEach(m=>appendMessage(m,false));
    feedOffset += msgs.length;
    totalMessages = j.total||0;
    $('feedHint').textContent = (feedOffset>=totalMessages)?'No more messages':'Scroll to load more';
  }catch(err){ console.error(err); $('feedHint').textContent='Failed to load'; }
  finally{ loading=false; }
}
function appendMessage(m, optimistic){
  const feed=$('feed'); 
  const el=document.createElement('div'); el.className='msg-card'; el.dataset.id=m.id;
  el.innerHTML = `
    <div class="avatar">${(m.name||'A').slice(0,1).toUpperCase()}</div>
    <div class="msg-body">
      <div class="msg-header">
        <div class="msg-name">${m.name||'Anonymous'}</div>
        <div class="msg-ts">${new Date(m.ts||m.date||'').toLocaleString()}</div>
      </div>
      <div class="msg-text">${m.text||''}</div>
      ${m.image?`<img src="${m.image}" class="msg-image">` : ''}
      ${m.link?`<a href="${m.link}" target="_blank" class="small">${m.link}</a>` : ''}
    </div>`;
  if(optimistic) feed.insertBefore(el, feed.firstChild);
  else feed.insertBefore(el, feed.firstChild);
}

// --- Refresh
$('refreshBtn').addEventListener('click', ()=> loadMessages(true));
document.addEventListener('DOMContentLoaded', ()=>{
  ensureUser();
  loadMessages(true);
  $('feed').addEventListener('scroll', ()=>{
    const feed=$('feed');
    if(loading) return;
    if(feed.scrollTop + feed.clientHeight >= feed.scrollHeight-60){
      if(feedOffset<totalMessages) loadMessages(false);
    }
  });
});
</script>
</body>
</html>

